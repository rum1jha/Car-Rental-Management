
CREATE OR REPLACE TRIGGER CHECK_DISCOUNT
AFTER INSERT OF DISCOUNT_ID ON PAYMENTS
WHEN DISCOUNT_ID IS NOT NULL
DECLARE 
    DB_TRANS_ID DISCOUNT.TRANS_ID%TYPE;
    DB_DISCOUNT_ID DISCOUNT.DISCOUNT_ID%TYPE;
        
    TYPE CUST IS VARRAY(20500) OF CUSTOMERS.CUSTOMER_ID%TYPE;
    CUST_ARR CUST := CUST();
    CUST_INDEX NUMBER := 1;
    FLAG NUMBER := 0;
    
    CURSOR C1 is select TRANS_ID from PAYMENTS WHERE PAY_DATE = SYSDATE AND DISCOUNT_ID = :new.DISCOUNT_ID AND STATUS = 'COMPLETED';
    
    ex_DISCOUNT_ID_ERROR EXCEPTION;
    
BEGIN
    
    FOR i IN C1 LOOP:
        CUST_ARR.EXTEND;
        SELECT CUSTOMER_ID INTO CUST_ARR[CUST_INDEX] FROM RIDE_TRANSACTION WHERE TRANS_ID = DB_TRANS_ID;
        CUST_INDEX := CUST_INDEX + 1;
    END LOOP;
            
    FOR i IN CUST_ARR.START .. CUST_ARR.END LOOP:
        FOR k IN CUST_ARR.START .. CUST_ARR.END LOOP:
            IF i = k THEN
                FLAG := FLAG + 1;
            END IF;
        END LOOP;
        EXIT WHEN IF FLAG >= 2 THEN
            dbms_output.put_line('Found multiple discount ID used by Cusomter: '||CUST_ARR[i] ||' on the same day !!!');
    END LOOP; 

7725 7726\7988
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        null;
    
    WHEN ex_DISCOUNT_ID_ERROR THEN
        dbms_output.put_line('Only one Discount ID ');
    
    
END CHECK_DISCOUNT;